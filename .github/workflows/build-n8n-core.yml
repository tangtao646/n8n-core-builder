name: Build and Release n8n Core

on:
  workflow_dispatch:
    inputs:
      n8n_version:
        description: 'è¦æ„å»ºçš„ n8n ç‰ˆæœ¬ (ä¾‹å¦‚: latest æˆ– 1.25.0)'
        required: true
        default: 'latest'

permissions:
  contents: write

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]
        include:
          - os: windows-latest
            artifact_name: n8n-core-windows.zip
          - os: macos-latest
            artifact_name: n8n-core-macos.zip
          - os: ubuntu-latest
            artifact_name: n8n-core-linux.zip

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build Package
        shell: bash
        run: |
          mkdir build_dir && cd build_dir
          npm init -y
          npm install n8n@${{ github.event.inputs.n8n_version }} --production

          # ç»Ÿä¸€ç˜¦èº«é€»è¾‘
          find node_modules -type f \( -name "*.md" -o -name "*.map" -o -name "README" \) -delete || true
          find node_modules -type d \( -name "test" -o -name "tests" -o -name "example" \) -exec rm -rf {} + || true
          
          # æ ¹æ®ä¸åŒå¹³å°ä½¿ç”¨å¯¹åº”çš„å‹ç¼©å‘½ä»¤
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            7z a ../${{ matrix.artifact_name }} node_modules package.json
          else
            zip -r ../${{ matrix.artifact_name }} node_modules package.json
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_name }}

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: n8n-${{ github.event.inputs.n8n_version }}-${{ github.run_id }}
          name: Release-n8n-${{ github.event.inputs.n8n_version }}
          body: |
            # n8n Core Desktop Packages - Version ${{ github.event.inputs.n8n_version }}
            
            ## ğŸš€ CDN ä¸‹è½½é“¾æ¥ (jsDelivr)
            
            ### Windows
            ```
            https://cdn.jsdelivr.net/gh/${{ github.repository }}@n8n-${{ github.event.inputs.n8n_version }}-${{ github.run_id }}/n8n-core-windows.zip
            ```
            
            ### macOS
            ```
            https://cdn.jsdelivr.net/gh/${{ github.repository }}@n8n-${{ github.event.inputs.n8n_version }}-${{ github.run_id }}/n8n-core-macos.zip
            ```
            
            ### Linux
            ```
            https://cdn.jsdelivr.net/gh/${{ github.repository }}@n8n-${{ github.event.inputs.n8n_version }}-${{ github.run_id }}/n8n-core-linux.zip
            ```
            
            ## ğŸ“¦ ç›´æ¥ä¸‹è½½ (GitHub)
            
            ### Windows
            [n8n-core-windows.zip](https://github.com/${{ github.repository }}/releases/download/n8n-${{ github.event.inputs.n8n_version }}-${{ github.run_id }}/n8n-core-windows.zip)
            
            ### macOS
            [n8n-core-macos.zip](https://github.com/${{ github.repository }}/releases/download/n8n-${{ github.event.inputs.n8n_version }}-${{ github.run_id }}/n8n-core-macos.zip)
            
            ### Linux
            [n8n-core-linux.zip](https://github.com/${{ github.repository }}/releases/download/n8n-${{ github.event.inputs.n8n_version }}-${{ github.run_id }}/n8n-core-linux.zip)
            
            ---
            
            *æ„å»ºæ—¶é—´ï¼š${{ github.run_number }} | è¿è¡ŒIDï¼š${{ github.run_id }}*
          draft: false
          prerelease: false
          files: |
            ./artifacts/n8n-core-windows.zip/n8n-core-windows.zip
            ./artifacts/n8n-core-macos.zip/n8n-core-macos.zip
            ./artifacts/n8n-core-linux.zip/n8n-core-linux.zip