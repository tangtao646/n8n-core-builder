name: Build and Release n8n Core

on:
  workflow_dispatch:
    inputs:
      n8n_version:
        description: '要构建的 n8n 版本 (例如: latest 或 1.25.0)'
        required: true
        default: 'latest'

# 核心修正 1：赋予 Actions 写入 Release 的权限
permissions:
  contents: write

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]
        include:
          - os: windows-latest
            artifact_name: n8n-core-windows.zip
          - os: macos-latest
            artifact_name: n8n-core-macos.zip
          - os: ubuntu-latest
            artifact_name: n8n-core-linux.zip

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build Package
        # 核心修正 2：Windows 下使用 bash 环境统一清理命令
        shell: bash
        run: |
          mkdir build_dir && cd build_dir
          npm init -y
          npm install n8n@${{ github.event.inputs.n8n_version }} --production
          
          # 统一瘦身逻辑
          find node_modules -type f \( -name "*.md" -o -name "*.map" -o -name "README" \) -delete || true
          find node_modules -type d \( -name "test" -o -name "tests" -o -name "example" \) -exec rm -rf {} + || true
          
          # 根据不同平台使用对应的压缩命令
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            # Windows Actions 环境自带 7z，比 zip 指令更稳
            7z a ../${{ matrix.artifact_name }} node_modules package.json
          else
            zip -r ../${{ matrix.artifact_name }} node_modules package.json
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_name }}

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2  # 使用更稳定的 v2 版本
        with:
          # 核心修正 3：使用 run_id 确保 tag 唯一性，防止发布失败
          tag_name: n8n-${{ github.event.inputs.n8n_version }}-${{ github.run_id }}
          name: Release n8n ${{ github.event.inputs.n8n_version }}
          body: "Auto-generated n8n core packages for desktop."
          draft: false
          prerelease: false
          files: |
            ./artifacts/n8n-core-windows.zip/n8n-core-windows.zip
            ./artifacts/n8n-core-macos.zip/n8n-core-macos.zip
            ./artifacts/n8n-core-linux.zip/n8n-core-linux.zip